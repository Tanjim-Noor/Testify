# Online Exam Management System - Backend

FastAPI backend for the Online Exam Management System.

## Prerequisites

- Python 3.9+
- Docker & Docker Compose
- Git

## Project Setup

### 1. Clone and Navigate

```powershell
git clone <repository-url>
cd backend
```

### 2. Create Virtual Environment

**Windows (PowerShell):**
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
```

**Linux/Mac:**
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. Install Dependencies

```powershell
pip install -r requirements.txt
```

### 4. Environment Configuration

```powershell
Copy-Item .env.example .env
```

Edit `.env` with your settings (default values are provided in `.env.example`).

## Database Setup

### Start Docker Containers

```powershell
cd docker
docker-compose up -d
cd ..
```

Verify containers are running:
```powershell
docker-compose -f docker/docker-compose.yml ps
```

### Initialize Database

The project uses Alembic for database migrations. To set up the database:

```powershell
# Apply all migrations
alembic upgrade head

# Or use the helper script
.\scripts\migrate.ps1
```

**Note:** The `src/config/init_db.py` script is deprecated. Use Alembic migrations instead.

### Access Database (pgAdmin)

- **URL:** http://localhost:5050
- **Email:** admin@testify.local
- **Password:** admin_password

To register PostgreSQL server in pgAdmin:
- **Host:** postgres
- **Port:** 5432
- **Username:** admin
- **Password:** admin_password
- **Database:** testify_db

## Running the Application

### Start FastAPI Server

**Windows (PowerShell):**
```powershell
.\run_server.ps1
```

**Or manually:**
```powershell
python -m uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

**Linux/Mac:**
```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### Access API

- **API Docs:** http://localhost:8000/docs
- **Alternative Docs:** http://localhost:8000/redoc
- **Health Check:** http://localhost:8000/health
- **Database Health:** http://localhost:8000/db-health

## Database Migrations

This project uses [Alembic](https://alembic.sqlalchemy.org/) for database schema migrations. Alembic allows you to version control your database schema and apply changes incrementally.

### Common Migration Commands

#### Create a New Migration

After modifying SQLAlchemy models, create a migration:

```powershell
alembic revision --autogenerate -m "Description of changes"

# Or use the helper script
.\scripts\create_migration.ps1 "Description of changes"
```

**Important:** Always review the auto-generated migration file before applying it!

#### Apply Migrations

Apply all pending migrations to bring the database up to date:

```powershell
alembic upgrade head

# Or use the helper script
.\scripts\migrate.ps1
```

Important: If you added a new database index (for example: a GIN index for Postgres `ARRAY` on `tags`), Alembic's autogenerate may not always include special index creation syntax (e.g., `postgresql_using="gin"` for GIN indices). After you run the autogenerate command you should:

1. Open the newly-created migration file under `alembic/versions/`.
2. Confirm the operations. For example, to add a GIN index on `questions.tags` you may need to add:

```python
op.create_index("ix_questions_tags_gin", "questions", ["tags"], postgresql_using="gin")
```

3. Save and review the SQL generated by Alembic before running `alembic upgrade head`.

If you accidentally created a manual migration file (e.g., `add_indexes_to_questions.py`) instead of using `alembic revision --autogenerate`, delete it and then generate the migration properly with the CLI command.

#### Rollback Migration

Rollback the last migration:

```powershell
alembic downgrade -1

# Or use the helper script
.\scripts\rollback.ps1
```

Rollback all migrations:

```powershell
alembic downgrade base
```

#### View Migration Status

View current migration version:

```powershell
alembic current

# Or use the helper script
.\scripts\current_version.ps1
```

View migration history:

```powershell
alembic history

# Or use the helper script
.\scripts\migration_history.ps1
```

### Migration Best Practices

1. **Always Review Auto-Generated Migrations**
   - Alembic's autogenerate is smart but not perfect
   - Check the generated SQL before applying
   - Add comments for complex changes

2. **Test Migrations Before Production**
   - Test both upgrade and downgrade paths
   - Verify data integrity after migration
   - Test on a copy of production data when possible

3. **Never Edit Applied Migrations**
   - Once a migration is applied, create a new one for changes
   - Keep migration history clean and linear
   - Use `alembic stamp` only when necessary

4. **Keep Migrations Small and Focused**
   - One logical change per migration
   - Makes rollbacks easier
   - Easier to review and debug

5. **Use Descriptive Migration Messages**
   - Good: "Add email_verified field to users table"
   - Bad: "Update users" or "Fix stuff"

6. **Handle Data Migrations Carefully**
   - Separate schema changes from data migrations when possible
   - Use `op.execute()` for custom SQL
   - Consider large dataset implications

### Troubleshooting

#### Migration Conflicts

If you have migration conflicts:

```powershell
# View current state
alembic current

# View history
alembic history

# Stamp database to specific version (use with caution)
alembic stamp <revision_id>
```

#### Database Out of Sync

If your database schema doesn't match your models:

```powershell
# Create a new migration to sync
alembic revision --autogenerate -m "Sync database schema"

# Review and apply
alembic upgrade head
```

#### Reset Database (Development Only)

```powershell
# Rollback all migrations
alembic downgrade base

# Apply all migrations
alembic upgrade head
```

### Helper Scripts

The `scripts/` directory contains PowerShell helpers:

- `create_migration.ps1` - Create new migration
- `migrate.ps1` - Apply all pending migrations
- `rollback.ps1` - Rollback last migration
- `migration_history.ps1` - View migration history
- `current_version.ps1` - View current version

## Project Structure

```
backend/
├── alembic/                 # Database migrations
│   ├── versions/            # Migration files
│   └── env.py              # Alembic environment
├── scripts/                 # Helper scripts
│   ├── create_migration.ps1
│   ├── migrate.ps1
│   ├── rollback.ps1
│   ├── migration_history.ps1
│   └── current_version.ps1
├── src/
│   ├── config/
│   │   ├── settings.py      # Configuration
│   │   ├── database.py      # SQLAlchemy setup
│   │   └── init_db.py       # Database initialization (deprecated)
│   ├── models/              # Database models
│   ├── routes/              # API endpoints
│   ├── schemas/             # Request/response schemas
│   ├── services/            # Business logic
│   ├── utils/               # Utilities
│   └── main.py             # FastAPI app entry
├── tests/                  # Test files
├── docker/                 # Docker configuration
│   └── docker-compose.yml  # Docker services
├── alembic.ini            # Alembic configuration
├── .env.example           # Environment template
├── requirements.txt       # Python dependencies
└── README.md             # This file
```

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DATABASE_URL` | postgresql://admin:admin_password@localhost:5432/testify_db | PostgreSQL connection |
| `POSTGRES_DB` | testify_db | Database name |
| `POSTGRES_USER` | admin | Database user |
| `POSTGRES_PASSWORD` | admin_password | Database password |
| `PGADMIN_DEFAULT_EMAIL` | admin@testify.local | pgAdmin login email |
| `PGADMIN_DEFAULT_PASSWORD` | admin_password | pgAdmin login password |
| `JWT_SECRET` | your-secret-key-change-in-production | JWT signing key |
| `JWT_EXPIRATION` | 30 | Token expiration (minutes) |

## Testing

The project now ships with a comprehensive pytest suite located under `tests/comprehensive testing/`. The suite uses a SQLite-backed test database that is created and destroyed per test via `tests/conftest.py`, ensuring isolation without touching your local Postgres instance. Core fixtures you can reuse in new tests include:

- `test_db` / `db_session`: spin up a temporary SQLite database and transaction-aware SQLAlchemy session.
- `client`: FastAPI `TestClient` wired to the temporary DB.
- `admin_user` / `student_user` and their `*_token`/`*_headers` counterparts for authenticated requests.
- `sample_exam`, `sample_questions`, and `student_exam` to pre-load realistic exam data.

Helper builders such as `create_test_user` and `create_test_exam` live in `tests/helpers.py` so test files stay concise.

Pytest is configured via `pytest.ini` to auto-discover tests, run with `asyncio_mode=auto`, and enforce 80% coverage using `pytest-cov`. HTML coverage reports are emitted to `htmlcov/` by default.

```powershell
pytest -vv
```

To run common suites quickly, use `tests/run_tests.sh`, which wraps:

```bash
pytest -vv                             # full suite
pytest -vv --cov=src --cov-report=html # coverage run
pytest -vv tests/comprehensive\ testing/test_auth.py
pytest -vv -k "test_grade"
```

### Service-layer coverage

The `tests/comprehensive testing/test_services_core.py` module targets low-level service logic (exam, answer, results, and student exam services) without going through FastAPI routes. This keeps business rules well covered while letting you iterate quickly. During focused development runs you can temporarily skip coverage enforcement with:

```powershell
pytest --no-cov "tests/comprehensive testing/test_services_core.py" -vv
```

Always run the full suite (with coverage) before pushing to ensure the global 80% threshold still passes.

### Integration tests (requires Postgres)

Integration tests exercise the database and require a running Postgres service (docker-compose).

1. Start the Docker containers defined in `docker/docker-compose.yml`:

```powershell
cd docker
docker-compose up -d
cd ..
```

2. Ensure the database is reachable (see `DB_HOST`, etc. in `.env`).

3. Create the migration with Alembic (autogenerate diff):

```powershell
alembic revision --autogenerate -m "Add indexes to questions"

# Review the generated migration and add arrays or GIN index types if required; e.g.:
# op.create_index("ix_questions_tags_gin", "questions", ["tags"], postgresql_using="gin")
```

4. Apply migrations and run only integration tests:

```powershell
# Apply DB migrations (ensure you reviewed autogen'd file and adjusted any server-side defaults or indexes)
alembic upgrade head

# Run only integration tests (these hit the running Postgres instance)
pytest -q -m integration
```

The repository contains separate integration test files for major features:
- `tests/test_integration_question_service.py` - questions/service import & DB checks
- `tests/test_integration_exam_service.py` - exam lifecycle: create -> assign -> publish
 - `tests/phase_08_student_exam/test_integration_student_exam.py` - student exam lifecycle integration tests (start, answers, submit, auto-expire)

Phase-based test organization
----------------------------

Tests are now organized by development phase in the `tests/` folder. Each phase folder contains unit/integration tests relevant to that phase. This organization makes it easier to run and maintain tests as features are implemented incrementally.

Example phase folders:
- `backend/tests/phase_05_excel_import/` - tests for Excel import
- `backend/tests/phase_06_question_crud/` - question CRUD tests
- `backend/tests/phase_07_exam_management/` - exam management tests
- `backend/tests/phase_08_student_exam/` - student exam flow tests

Run only tests for a given phase:
```powershell
pytest backend/tests/phase_08_student_exam -q
Note on running tests from repository root
---------------------------------------

To make tests import `src` regardless of your current working directory, the test suite includes `backend/tests/conftest.py` which adds the `backend` path to `sys.path`. This means:

- Running pytest from the project root works:
```powershell
pytest backend/tests/phase_08_student_exam -q
```
- You can also run pytest from `backend` directory if you prefer:
```powershell
cd backend
pytest -q
```

If you encounter `ModuleNotFoundError: No module named 'src'`, ensure you are running tests from the project root and not using an alternate virtualenv that masks sys.path manipulation. As a workaround you can set `PYTHONPATH` explicitly:

```powershell
$env:PYTHONPATH = "${PWD}\backend"
pytest backend/tests/phase_08_student_exam -q
```
```

Run a single test file or a test function:
```powershell
pytest backend/tests/phase_08_student_exam/test_routes_student.py -q
pytest backend/tests/phase_08_student_exam/test_routes_student.py::test_start_exam -q
```

Tip: use `-k <expr>` to selectively run tests by keyword, for example `pytest -k student -q`.

Note: After making schema changes (for example timezone-aware defaults), Alembic's autogenerate may produce an empty migration if changes are only Python-level defaults. This is expected; however if you need the DB to reflect server defaults or new indexes, add them manually to the migration file under `alembic/versions/` before running `alembic upgrade head`.

If `pytest` reports the integration test was skipped, check that Docker containers are running and `DATABASE_URL` in `.env` is configured to point to the running Postgres instance (commented examples exist in `.env.example`).

## Technologies

- **FastAPI** - Web framework
- **SQLAlchemy** - ORM
- **PostgreSQL** - Database
- **Pydantic** - Data validation
- **Docker** - Containerization

## Next Steps

See `project phases/` directory for detailed phase information:
- Phase 2: Database Setup ✅
- Phase 3: Database Models
- Phase 4: Authentication
- Phase 5+: Features
